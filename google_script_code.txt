/* 
 * Google Apps Script to Handle Form Submissions
 * Copy everything below this line into your Google Apps Script editor (Extensions > Apps Script).
 */

function doPost(e) {
  try {
    // 1. Get the sheet
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // 2. Parse the incoming JSON data
    var data = JSON.parse(e.postData.contents);
    
    // 3. Define the data keys (incoming from form) AND the display headers (for the sheet)
    // Format: [ "jsonKey", "Display Header Name" ]
    var mapping = [
      ["timestamp", "Timestamp"],
      ["firstName", "First Name"],
      ["lastName", "Last Name"],
      ["phone", "Phone Number"],
      ["email", "Email Address"],
      ["preferredContact", "Preferred Contact"],
      ["agent", "Has Agent?"],
      ["propertyInterest", "Property Interest"],
      ["bedrooms", "Bedrooms"],
      ["neighborhoods", "Neighborhoods"],
      ["moveInDate", "Move-In Date"],
      ["budget", "Budget"],
      ["nonNegotiables", "Must Haves"],
      ["hasPets", "Has Pets?"],
      ["catCount", "Cat Count"],
      ["dogCount", "Dog Count"],
      ["dogDetails", "Dog Details"],
      ["coapplicants", "Co-Applicants?"],
      ["evictions", "Evictions?"],
      ["verifiableIncome", "Income Verified?"],
      ["creditScore", "Credit Score"],
      ["tourDays", "Tour Days"],
      ["tourTimes", "Tour Times"],
      ["notes", "Notes"]
    ];
    
    // Extract headers for the sheet
    var headers = mapping.map(function(pair) { return pair[1]; });
    
    // 4. If the sheet is empty, add the headers first
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(headers);
    }
    
    // 5. Map the data to the row based on the keys
    var row = mapping.map(function(pair) {
      var key = pair[0];
      return data[key] || "";
    });
    
    // 6. Add the new row
    sheet.appendRow(row);
    
    // 7. Return success
    return ContentService.createTextOutput(JSON.stringify({ "result": "success" }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    // Return error if something goes wrong
    return ContentService.createTextOutput(JSON.stringify({ "result": "error", "error": error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
